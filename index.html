<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề Kiểm Tra Toán 12 - Đề Mới (Chuẩn Ma Trận)</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #0d6efd;
            --success: #198754;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #212529;
        }
        body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background-color: #f0f2f5; color: var(--dark); line-height: 1.6; margin: 0; padding-bottom: 80px; }
        
        /* Header */
        .fixed-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: white; padding: 12px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;
        }
        .timer-badge {
            font-size: 1.3rem; font-weight: 700; color: var(--danger);
            border: 2px solid var(--danger); padding: 5px 15px; border-radius: 25px; background: #fff;
        }

        /* Container */
        .container { max-width: 960px; margin: 80px auto 20px; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        h1 { text-align: center; color: var(--primary); margin-bottom: 5px; }
        .sub-title { text-align: center; color: #6c757d; font-style: italic; margin-bottom: 30px; }

        .part-header {
            background-color: var(--primary); color: white;
            padding: 12px 20px; margin-top: 40px; margin-bottom: 20px;
            border-radius: 6px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* Question Box */
        .question-box {
            border: 1px solid #e9ecef; border-radius: 8px;
            padding: 20px; margin-bottom: 25px; background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .q-title { font-weight: 700; color: var(--primary); margin-bottom: 10px; display: block; }
        .q-content { margin-bottom: 15px; }

        /* Tables */
        table.stats-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.95rem; }
        table.stats-table th, table.stats-table td { border: 1px solid #dee2e6; padding: 10px; text-align: center; }
        table.stats-table th { background-color: #e9ecef; color: var(--dark); font-weight: 600; }

        /* Multiple Choice */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .option-label {
            display: flex; align-items: center; cursor: pointer;
            padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; transition: 0.2s;
        }
        .option-label:hover { background-color: #e7f1ff; border-color: var(--primary); }
        .option-label input { margin-right: 12px; transform: scale(1.3); }

        /* True/False */
        .tf-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px dashed #dee2e6;
        }
        .tf-text { flex: 1; padding-right: 20px; }
        .tf-opts { display: flex; gap: 25px; font-weight: bold; min-width: 140px; }

        /* Short Answer */
        .short-input {
            width: 100%; max-width: 300px; padding: 12px;
            border: 2px solid #dee2e6; border-radius: 6px; font-size: 1.1rem;
        }
        .short-input:focus { border-color: var(--primary); outline: none; }

        /* Feedback */
        .feedback {
            margin-top: 15px; padding: 15px; border-radius: 6px;
            display: none; font-size: 0.95rem; background-color: #f8f9fa; border-left: 5px solid #ccc;
        }
        .correct-fb { border-left-color: var(--success); background-color: #d1e7dd; color: #0f5132; }
        .wrong-fb { border-left-color: var(--danger); background-color: #f8d7da; color: #842029; }

        /* Button */
        .btn-submit {
            display: block; width: 100%; padding: 16px;
            background-color: var(--success); color: white;
            border: none; border-radius: 8px; font-size: 1.3rem; font-weight: bold;
            cursor: pointer; margin-top: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-submit:hover { background-color: #157347; }
        .btn-disabled { background-color: #6c757d; cursor: not-allowed; }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 40px; border-radius: 12px;
            text-align: center; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .score-circle {
            font-size: 3.5rem; font-weight: 800; color: var(--primary); margin: 20px 0;
        }

        @media (max-width: 768px) {
            .options-grid { grid-template-columns: 1fr; }
            .tf-item { flex-direction: column; align-items: flex-start; }
            .tf-opts { margin-top: 10px; width: 100%; justify-content: space-around; }
        }
    </style>
</head>
<body>

<div class="fixed-header">
    <div style="font-weight: bold; font-size: 1.1rem;">TOÁN 12 - ĐỀ SỐ 02</div>
    <div class="timer-badge" id="timer">60:00</div>
</div>

<div class="container">
    <h1>ĐỀ KIỂM TRA ĐỊNH KỲ</h1>
    <div class="sub-title">Cấu trúc theo Ma trận đặc tả - Số liệu mới<br>Tự động đảo câu hỏi khi tải lại trang</div>

    <form id="quizForm">
        <div id="render-area"></div>
        <button type="button" class="btn-submit" onclick="submitQuiz()">NỘP BÀI & XEM ĐIỂM</button>
    </form>
</div>

<div class="modal" id="resultModal">
    <div class="modal-box">
        <h2>KẾT QUẢ LÀM BÀI</h2>
        <div class="score-circle" id="finalScore">0.0</div>
        <p>Điểm số trên thang điểm 10</p>
        <button class="btn-submit" onclick="closeModal()" style="margin-top: 10px;">Xem chi tiết đáp án</button>
    </div>
</div>

<script>
    // ================= DỮ LIỆU ĐỀ BÀI (NEW DATA) =================

    // --- PHẦN 1: 10 CÂU TRẮC NGHIỆM (Nhận biết/Thông hiểu) ---
    const part1DB = [
        {
            id: "p1_1",
            text: "Cho hàm số \\(y = f(x)\\) có bảng biến thiên như sau. Hàm số đã cho nghịch biến trên khoảng nào?",
            content: "<table class='stats-table' style='width:auto; margin:0 auto;'><tr><th>x</th><td>$-\\infty$</td><td>0</td><td>2</td><td>$+\\infty$</td></tr><tr><th>y'</th><td>+</td><td>0</td><td>-</td><td>0</td><td>+</td></tr><tr><th>y</th><td></td><td></td><td></td><td></td><td></td></tr></table>",
            options: ["A. \\((0; 2)\\)", "B. \\((2; +\\infty)\\)", "C. \\((-\\infty; 0)\\)", "D. \\((0; +\\infty)\\)"],
            correct: 0,
            explain: "Dựa vào BBT, \\(y' < 0\\) trên khoảng \\((0; 2)\\)."
        },
        {
            id: "p1_2",
            text: "Tìm giá trị lớn nhất \\(M\\) của hàm số \\(y = x^4 - 2x^2 + 3\\) trên đoạn \\([0; 2]\\).",
            options: ["A. \\(M = 11\\)", "B. \\(M = 3\\)", "C. \\(M = 2\\)", "D. \\(M = 5\\)"],
            correct: 0,
            explain: "\\(y' = 4x^3 - 4x\\). Nghiệm \\(0, 1\\) thuộc đoạn. \\(y(0)=3, y(1)=2, y(2)=11\\). Vậy Max=11."
        },
        {
            id: "p1_3",
            text: "Tiệm cận ngang của đồ thị hàm số \\(y = \\frac{3x - 1}{x + 2}\\) là đường thẳng:",
            options: ["A. \\(y = 3\\)", "B. \\(x = -2\\)", "C. \\(y = -2\\)", "D. \\(y = 1/3\\)"],
            correct: 0,
            explain: "Tiệm cận ngang \\(y = \\frac{a}{c} = \\frac{3}{1} = 3\\)."
        },
        {
            id: "p1_4",
            text: "Đồ thị của hàm số nào dưới đây có dạng như đường cong trong hình vẽ? (Biết đồ thị là hàm bậc 3, hệ số \\(a<0\\), đi qua gốc tọa độ)",
            options: ["A. \\(y = -x^3 + 3x\\)", "B. \\(y = x^3 - 3x\\)", "C. \\(y = -x^4 + 2x^2\\)", "D. \\(y = -x^3 + 3x + 1\\)"],
            correct: 0,
            explain: "Dạng chữ N ngược \\(\\Rightarrow a<0\\). Đi qua O(0,0) nên loại D. Hàm bậc 3 nên loại C. Chọn A."
        },
        {
            id: "p1_5",
            text: "Trong không gian Oxyz, cho hai vectơ \\(\\vec{a} = (2; -1; 3)\\) và \\(\\vec{b} = (1; 1; -2)\\). Tích vô hướng \\(\\vec{a} \\cdot \\vec{b}\\) bằng:",
            options: ["A. -5", "B. 5", "C. -1", "D. 7"],
            correct: 0,
            explain: "\\(\\vec{a} \\cdot \\vec{b} = 2.1 + (-1).1 + 3.(-2) = 2 - 1 - 6 = -5\\)."
        },
        {
            id: "p1_6",
            text: "Trong không gian Oxyz, tọa độ trọng tâm G của tam giác ABC với \\(A(1;0;0), B(0;2;0), C(0;0;3)\\) là:",
            options: ["A. \\((1/3; 2/3; 1)\\)", "B. \\((1; 2; 3)\\)", "C. \\((1/3; 2/3; 1/3)\\)", "D. \\((3; 6; 9)\\)"],
            correct: 0,
            explain: "\\(x_G = (1+0+0)/3, y_G = (0+2+0)/3, z_G = (0+0+3)/3\\)."
        },
        {
            id: "p1_7",
            text: "Trong không gian Oxyz, cho \\(\\vec{u} = 2\\vec{i} - 3\\vec{j} + 5\\vec{k}\\). Tọa độ của vectơ \\(\\vec{u}\\) là:",
            options: ["A. \\((2; -3; 5)\\)", "B. \\((2; 3; 5)\\)", "C. \\((2; -3; 0)\\)", "D. \\((5; -3; 2)\\)"],
            correct: 0,
            explain: "Hệ số của \\(\\vec{i}, \\vec{j}, \\vec{k}\\) lần lượt là hoành, tung, cao độ."
        },
        {
            id: "p1_8",
            text: "Cho hình hộp \\(ABCD.A'B'C'D'\\). Vectơ \\(\\overrightarrow{AC'}\\) bằng vectơ nào sau đây?",
            options: ["A. \\(\\overrightarrow{AB} + \\overrightarrow{AD} + \\overrightarrow{AA'}\\)", "B. \\(\\overrightarrow{AB} + \\overrightarrow{AC} + \\overrightarrow{AA'}\\)", "C. \\(\\overrightarrow{AB} + \\overrightarrow{AD}\\)", "D. \\(\\overrightarrow{AD} + \\overrightarrow{AA'}\\)"],
            correct: 0,
            explain: "Quy tắc hình hộp: Đường chéo chính bằng tổng 3 vectơ cạnh xuất phát từ cùng 1 đỉnh."
        },
        {
            id: "p1_9",
            text: "Cho mẫu số liệu ghép nhóm về thời gian tập thể dục (phút): <br> [0;20): 5, [20;40): 10, [40;60): 15, [60;80): 8, [80;100): 2. <br> Số nhóm của mẫu số liệu là:",
            options: ["A. 5", "B. 4", "C. 6", "D. 3"],
            correct: 0,
            explain: "Có 5 nhóm số liệu."
        },
        {
            id: "p1_10",
            text: "Khoảng biến thiên của mẫu số liệu ở câu 9 là:",
            options: ["A. 100", "B. 80", "C. 20", "D. 40"],
            correct: 0,
            explain: "R = Max biên phải (100) - Min biên trái (0) = 100."
        }
    ];

    // --- PHẦN 2: 3 CÂU ĐÚNG SAI (Mỗi câu 4 ý) ---
    const part2DB = [
        {
            id: "p2_1",
            text: "Cho hàm số \\(y = \\frac{x^2 - 3x + 6}{x - 2}\\). Xét tính đúng sai của các mệnh đề sau:",
            sub: [
                { text: "a) Tập xác định của hàm số là \\(D = \\mathbb{R} \\setminus \\{2\\}\\).", ans: true, explain: "Đúng." },
                { text: "b) Đạo hàm \\(y' = \\frac{x^2 - 4x}{(x-2)^2}\\).", ans: true, explain: "Đúng. \\(y = x-1 + 4/(x-2) \\Rightarrow y' = 1 - 4/(x-2)^2\\)." },
                { text: "c) Đồ thị hàm số có tiệm cận xiên là đường thẳng \\(y = x - 3\\).", ans: false, explain: "Sai. Tiệm cận xiên là \\(y = x - 1\\)." },
                { text: "d) Hàm số đạt cực tiểu tại \\(x = 0\\).", ans: false, explain: "Sai. Cực đại tại x=0, cực tiểu tại x=4." }
            ]
        },
        {
            id: "p2_2",
            text: "Trong không gian Oxyz, cho ba điểm \\(A(2; 0; 0), B(0; 3; 0), C(0; 0; 4)\\).",
            sub: [
                { text: "a) Vectơ \\(\\overrightarrow{BC} = (0; -3; 4)\\).", ans: true, explain: "Đúng. \\(C-B\\)." },
                { text: "b) Tam giác ABC là tam giác vuông tại O.", ans: false, explain: "Sai. O không thuộc mp(ABC) và các cạnh không thỏa Pytago." },
                { text: "c) Phương trình mặt phẳng (ABC) là \\(\\frac{x}{2} + \\frac{y}{3} + \\frac{z}{4} = 0\\).", ans: false, explain: "Sai. Phải bằng 1 (phương trình đoạn chắn)." },
                { text: "d) Thể tích tứ diện OABC bằng 4.", ans: true, explain: "Đúng. \\(V = 1/6 . OA.OB.OC = 1/6 . 2.3.4 = 4\\)." }
            ]
        },
        {
            id: "p2_3",
            text: "Thống kê năng suất lúa (tạ/ha) của hai vùng A và B như sau:<br><table class='stats-table'><tr><th>Năng suất</th><td>[45;50)</td><td>[50;55)</td><td>[55;60)</td><td>[60;65)</td><td>[65;70)</td></tr><tr><th>Vùng A</th><td>5</td><td>15</td><td>20</td><td>8</td><td>2</td></tr><tr><th>Vùng B</th><td>2</td><td>8</td><td>15</td><td>20</td><td>5</td></tr></table>",
            sub: [
                { text: "a) Cỡ mẫu của vùng A là 50.", ans: true, explain: "Đúng (5+15+20+8+2=50)." },
                { text: "b) Số trung bình của vùng B lớn hơn vùng A.", ans: true, explain: "Đúng. Phân phối B lệch về phía năng suất cao hơn." },
                { text: "c) Nhóm chứa mốt của vùng A là [50;55).", ans: false, explain: "Sai. Nhóm chứa mốt của A là [55;60) (tần số 20)." },
                { text: "d) Độ lệch chuẩn của vùng B nhỏ hơn vùng A.", ans: false, explain: "Sai. Vùng B trải rộng hơn ở phía cao, vùng A tập trung tốt hơn ở giữa." }
            ]
        }
    ];

    // --- PHẦN 3: 3 CÂU TRẢ LỜI NGẮN (Vận dụng) ---
    const part3DB = [
        {
            id: "p3_1",
            text: "Một người nông dân muốn rào một mảnh vườn hình chữ nhật tiếp giáp với bờ sông (không cần rào phía bờ sông). Người đó có 100m hàng rào. Tìm diện tích lớn nhất có thể rào được (đơn vị: \\(m^2\\)).",
            ans: 1250,
            tolerance: 1,
            explain: "Gọi cạnh vuông góc sông là x. Cạnh kia là 100-2x. Diện tích S = x(100-2x) = -2x^2 + 100x. Max tại x = 25. S = 25*50 = 1250."
        },
        {
            id: "p3_2",
            text: "Trong một phòng học, chọn hệ trục Oxyz với góc phòng là gốc O. Một camera được lắp tại điểm \\(K(5; 4; 3)\\) (đơn vị mét). Tính khoảng cách từ camera đến góc phòng O (làm tròn đến hàng phần mười).",
            ans: 7.1,
            tolerance: 0.1,
            explain: "\\(OK = \\sqrt{5^2 + 4^2 + 3^2} = \\sqrt{25+16+9} = \\sqrt{50} \\approx 7.07\\). Làm tròn 7.1."
        },
        {
            id: "p3_3",
            text: "Thống kê thời gian (phút) hoàn thành bài kiểm tra của 40 học sinh: <br> <table class='stats-table'><tr><th>Thời gian</th><td>[15;20)</td><td>[20;25)</td><td>[25;30)</td><td>[30;35)</td><td>[35;40)</td></tr><tr><th>Số HS</th><td>4</td><td>10</td><td>16</td><td>8</td><td>2</td></tr></table> Tính trung vị của mẫu số liệu (làm tròn đến 2 chữ số thập phân).",
            ans: 26.88,
            tolerance: 0.1,
            explain: "N=40. N/2=20. Nhóm chứa trung vị [25;30) (tích lũy trước là 14). <br> \\(M_e = 25 + \\frac{20-14}{16} \\times 5 = 25 + \\frac{6}{16} \\times 5 = 25 + 1.875 = 26.875\\)."
        }
    ];

    // ================= LOGIC XỬ LÝ (JavaScript) =================

    // Hàm đảo mảng ngẫu nhiên
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Render đề thi
    function renderQuiz() {
        const area = document.getElementById("render-area");
        let html = "";

        // --- PART 1 ---
        html += `<div class="part-header">PHẦN I. TRẮC NGHIỆM (10 CÂU)</div>`;
        const p1 = shuffle([...part1DB]);
        p1.forEach((q, idx) => {
            html += `
            <div class="question-box" id="q_${q.id}">
                <span class="q-title">Câu ${idx+1}:</span>
                <div class="q-content">${q.text}</div>
                ${q.content ? q.content : ''}
                <div class="options-grid">
                    ${q.options.map((opt, i) => `
                        <label class="option-label">
                            <input type="radio" name="${q.id}" value="${i}"> ${opt}
                        </label>
                    `).join('')}
                </div>
                <div class="feedback" id="fb_${q.id}"></div>
            </div>`;
        });

        // --- PART 2 ---
        html += `<div class="part-header">PHẦN II. TRẮC NGHIỆM ĐÚNG SAI (3 CÂU)</div>`;
        const p2 = shuffle([...part2DB]);
        p2.forEach((q, idx) => {
            html += `
            <div class="question-box" id="q_${q.id}">
                <span class="q-title">Câu ${idx+1}: ${q.text}</span>
                ${q.sub.map((s, i) => `
                    <div class="tf-item">
                        <div class="tf-text">${s.text}</div>
                        <div class="tf-opts">
                            <label><input type="radio" name="${q.id}_${i}" value="true"> Đúng</label>
                            <label><input type="radio" name="${q.id}_${i}" value="false"> Sai</label>
                        </div>
                    </div>
                    <div class="feedback" id="fb_${q.id}_${i}" style="margin-top:5px; padding:8px;"></div>
                `).join('')}
            </div>`;
        });

        // --- PART 3 ---
        html += `<div class="part-header">PHẦN III. TRẢ LỜI NGẮN (3 CÂU)</div>`;
        const p3 = shuffle([...part3DB]);
        p3.forEach((q, idx) => {
            html += `
            <div class="question-box" id="q_${q.id}">
                <span class="q-title">Câu ${idx+1}:</span>
                <div class="q-content">${q.text}</div>
                <div>
                    Đáp án: <input type="number" step="0.01" class="short-input" name="${q.id}" placeholder="Nhập số...">
                </div>
                <div class="feedback" id="fb_${q.id}"></div>
            </div>`;
        });

        area.innerHTML = html;
        MathJax.typeset();
    }

    // Timer Logic
    let time = 60 * 60; // 60 minutes
    const timerElem = document.getElementById("timer");
    const interval = setInterval(() => {
        time--;
        let m = Math.floor(time / 60);
        let s = time % 60;
        timerElem.innerText = `${m}:${s < 10 ? '0'+s : s}`;
        if (time <= 0) {
            clearInterval(interval);
            submitQuiz();
            alert("Hết giờ làm bài!");
        }
    }, 1000);

    // Grading Logic
    function submitQuiz() {
        clearInterval(interval);
        let score = 0;
        let maxRawScore = 0;

        // Grade Part 1 (0.25 pts each)
        part1DB.forEach(q => {
            maxRawScore += 0.25;
            const sel = document.querySelector(`input[name="${q.id}"]:checked`);
            const fb = document.getElementById(`fb_${q.id}`);
            fb.style.display = "block";
            
            if (sel && parseInt(sel.value) === q.correct) {
                score += 0.25;
                fb.className = "feedback correct-fb";
                fb.innerHTML = `<b>Chính xác!</b> ${q.explain}`;
            } else {
                fb.className = "feedback wrong-fb";
                fb.innerHTML = `<b>Sai rồi.</b> Đáp án đúng là phần chọn thứ ${q.correct + 1}. <br> ${q.explain}`;
            }
        });

        // Grade Part 2 (0.1 pts per sub-question - Simplified grading)
        part2DB.forEach(q => {
            q.sub.forEach((s, i) => {
                maxRawScore += 0.25; // Giả sử mỗi ý 0.25 để tổng 10
                const sel = document.querySelector(`input[name="${q.id}_${i}"]:checked`);
                const fb = document.getElementById(`fb_${q.id}_${i}`);
                fb.style.display = "block";

                const val = sel ? (sel.value === 'true') : null;
                if (val === s.ans) {
                    score += 0.25;
                    fb.innerHTML = `<span style="color:green">✓ ${s.explain}</span>`;
                } else {
                    fb.innerHTML = `<span style="color:red">✗ Đáp án: ${s.ans ? 'Đúng' : 'Sai'}.</span>`;
                }
            });
        });

        // Grade Part 3 (0.5 pts each)
        part3DB.forEach(q => {
            maxRawScore += 0.5;
            const inp = document.querySelector(`input[name="${q.id}"]`);
            const fb = document.getElementById(`fb_${q.id}`);
            fb.style.display = "block";

            const val = parseFloat(inp.value);
            if (!isNaN(val) && Math.abs(val - q.ans) <= q.tolerance) {
                score += 0.5;
                fb.className = "feedback correct-fb";
                fb.innerHTML = `<b>Chính xác!</b> Kết quả: ${q.ans}. <br> ${q.explain}`;
            } else {
                fb.className = "feedback wrong-fb";
                fb.innerHTML = `<b>Sai.</b> Đáp án đúng: ${q.ans}. <br> ${q.explain}`;
            }
        });

        // Calculate Final Score (Scale to 10)
        // Current Max Raw ~ 2.5 + 3 + 1.5 = 7.0
        const final = (score / maxRawScore) * 10;
        
        document.getElementById("finalScore").innerText = final.toFixed(2);
        document.getElementById("resultModal").style.display = "flex";
        
        // Disable Submit
        const btn = document.querySelector(".btn-submit");
        btn.disabled = true;
        btn.innerText = "ĐÃ HOÀN THÀNH";
        btn.classList.add("btn-disabled");
        
        window.scrollTo(0, 0);
    }

    function closeModal() {
        document.getElementById("resultModal").style.display = "none";
    }

    // Init
    window.onload = renderQuiz;

</script>
</body>
</html>
