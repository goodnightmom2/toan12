<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề Kiểm Tra Toán 12 - 60 Phút</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f8f9fa;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-bottom: 50px;
        }
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--danger);
            background: #fff0f0;
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid var(--danger);
        }
        .container {
            max-width: 900px;
            margin: 80px auto 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        h1, h2 { text-align: center; color: #333; }
        .part-title {
            background-color: var(--primary);
            color: white;
            padding: 10px 15px;
            margin-top: 30px;
            border-radius: 5px;
            font-size: 1.1rem;
        }
        .question-box {
            margin-bottom: 20px;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .q-text { font-weight: 600; margin-bottom: 10px; display: block; }
        .img-desc {
            background: #fff3cd;
            padding: 10px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
            font-size: 0.9em;
            font-style: italic;
        }
        /* Style cho bảng thống kê */
        table.stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.95em;
        }
        table.stats-table th, table.stats-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
        }
        table.stats-table th { background-color: #f2f2f2; font-weight: bold;}

        /* Style cho đáp án */
        .options label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }
        .options label:hover { background-color: #f0f0f0; }
        
        /* Đúng sai style */
        .tf-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #ddd;
        }
        .tf-content { width: 70%; }
        .tf-choices { width: 30%; display: flex; justify-content: space-around; }

        /* Input trả lời ngắn */
        .short-ans {
            padding: 8px;
            width: 200px;
            border: 2px solid #ccc;
            border-radius: 4px;
        }

        .btn-submit {
            display: block;
            width: 100%;
            padding: 15px;
            background: var(--success);
            color: white;
            border: none;
            font-size: 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 30px;
        }
        .btn-submit:hover { background: #218838; }

        /* Kết quả */
        .result-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .result-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        .score { font-size: 2rem; color: var(--primary); font-weight: bold; }
        
        /* Chấm điểm visual */
        .correct-ans { background-color: #d4edda !important; border: 1px solid #c3e6cb; }
        .wrong-ans { background-color: #f8d7da !important; border: 1px solid #f5c6cb; }
        .explanation { color: var(--danger); font-size: 0.9em; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <div><strong>Môn: Toán 12</strong></div>
        <div class="timer" id="timer">60:00</div>
    </div>

    <div class="container" id="quiz-container">
        <h1>ĐỀ KHẢO SÁT CHẤT LƯỢNG (ĐÃ SỬA LỖI)</h1>
        <p style="text-align: center;"><i>(Đề bài được đảo ngẫu nhiên mỗi lần tải lại trang)</i></p>
        
        <div id="render-area"></div>

        <button class="btn-submit" onclick="submitQuiz()">NỘP BÀI & XEM KẾT QUẢ</button>
    </div>

    <div class="result-overlay" id="resultModal">
        <div class="result-box">
            <h2>Kết Quả Làm Bài</h2>
            <div class="score" id="scoreDisplay">0 / 10</div>
            <p>Bạn có thể cuộn xuống để xem đáp án chi tiết.</p>
            <button class="btn-submit" onclick="closeModal()">Xem chi tiết bài làm</button>
        </div>
    </div>

<script>
    // ================= DỮ LIỆU ĐỀ BÀI (Đã sửa lỗi hiển thị) =================

    const part1Data = [
        {
            id: "p1_q1",
            text: "Cho hàm số \\( y = f(x) \\) có bảng biến thiên như sau: <br> \\(x\\): \\(-\\infty \\to -1 \\to 1 \\to +\\infty\\). <br> \\(f'(x)\\): (+) (0) (-) (0) (+). <br> \\(f(x)\\): Tăng lên 3, giảm xuống -2, tăng lên \\(+\\infty\\). <br> Hàm số đồng biến trên khoảng nào?",
            options: ["A. \\((-1; +\\infty)\\)", "B. \\((-\\infty; 1)\\)", "C. \\((-1; 1)\\)", "D. \\((1; +\\infty)\\)"],
            correct: 3
        },
        {
            id: "p1_q2",
            text: "Cho hàm số \\( y = f(x) \\) liên tục trên \\(\\mathbb{R}\\) có đồ thị bậc 3, cực đại tại \\(x=-1\\) ($y=-1$), cực tiểu tại \\(x=1\\) ($y=-5$). Tìm GTLN \\(M\\) và GTNN \\(m\\) trên đoạn \\([-2; 2]\\).",
            options: ["A. \\(m=-2; M=2\\)", "B. \\(m=-5; M=-1\\)", "C. \\(m=-5; M=0\\)", "D. \\(m=-1; M=0\\)"],
            correct: 2 
        },
        {
            id: "p1_q3",
            text: "Cho hình hộp chữ nhật \\(ABCD.A'B'C'D'\\). Khẳng định nào đúng?",
            // Sửa lỗi hiển thị overrightarrow thành \overrightarrow
            options: [
                "A. \\(\\overrightarrow{AD} = \\overrightarrow{AB}\\)", 
                "B. \\(\\overrightarrow{AB} = \\overrightarrow{D'C'}\\)", 
                "C. \\(\\overrightarrow{AD} = \\overrightarrow{A'C}\\)", 
                "D. \\(\\overrightarrow{AD} = \\overrightarrow{A'B'}\\)"
            ],
            correct: 1 
        },
        {
            id: "p1_q4",
            text: "Cho bảng số liệu ghép nhóm: <br> <table class='stats-table'><tr><th>Nhóm</th><td>[1.5; 2.5)</td><td>[2.5; 3.5)</td><td>[3.5; 4.5)</td><td>[4.5; 5.5)</td><td>[5.5; 6.5)</td></tr><tr><th>Tần số</th><td>2</td><td>3</td><td>7</td><td>2</td><td>1</td></tr></table> Khoảng biến thiên của mẫu số liệu là?",
            options: ["A. 5", "B. 4", "C. 2", "D. 3"],
            correct: 0 
        },
        {
            id: "p1_q5",
            text: "Trong không gian Oxyz, cho \\(\\vec{u}_1 = (x_1; y_1; z_1)\\), \\(\\vec{u}_2 = (x_2; y_2; z_2)\\). Tọa độ \\(\\vec{u} = \\vec{u}_1 + \\vec{u}_2\\) là:",
            // Sửa lỗi Math input error câu 8 ảnh cũ
            options: [
                "A. \\((x_1+x_2; y_1+y_2; z_1+z_2)\\)", 
                "B. \\((x_1-x_2; y_1-y_2; z_1-z_2)\\)", 
                "C. \\((x_1.x_2; y_1.y_2; z_1.z_2)\\)", 
                "D. \\((x_1+x_2; y_1-y_2; z_1+z_2)\\)"
            ],
            correct: 0 
        },
        {
            id: "p1_q6",
            text: "Cho \\(\\overrightarrow{OM} = 2\\vec{i} + 3\\vec{j} - 4\\vec{k}\\). Tìm tọa độ hình chiếu vuông góc H của M lên mặt phẳng (Oyz).",
            options: ["A. H(2;3;-4)", "B. H(-2;-3;4)", "C. H(0;3;-4)", "D. H(2;0;0)"],
            correct: 2 
        },
        {
            id: "p1_q7",
            text: "Đường thẳng \\(x=1\\) là tiệm cận đứng của đồ thị hàm số nào?",
            options: ["A. \\(y=\\frac{1}{x-1}\\)", "B. \\(y=\\frac{1}{x^2+1}\\)", "C. \\(y=\\frac{1}{x+1}\\)", "D. \\(y=\\frac{x-1}{x+1}\\)"],
            correct: 0 
        },
        {
            id: "p1_q8",
            text: "Cho \\(A(2;1;3)\\) và \\(B(4;-3;1)\\). Trung điểm I của AB là:",
            options: ["A. (6;-2;4)", "B. (2;-4;-2)", "C. (1;-2;-1)", "D. (3;-1;2)"],
            correct: 3 
        },
        {
            id: "p1_q9",
            text: "Hàm số nào có đồ thị như hình vẽ (Tiệm cận đứng x=1, tiệm cận xiên y=x)?",
            options: ["A. \\(y=-x+\\frac{1}{x-1}\\)", "B. \\(y=x-\\frac{1}{x-1}\\)", "C. \\(y=x+\\frac{1}{x-1}\\)", "D. \\(y=-x-\\frac{1}{x-1}\\)"],
            correct: 1 
        },
        {
            id: "p1_q10",
            text: "Thống kê tuổi thọ 20 con hổ: <br> <table class='stats-table'><tr><th>Tuổi thọ</th><td>[14;15)</td><td>[15;16)</td><td>[16;17)</td><td>[17;18)</td><td>[18;19)</td></tr><tr><th>Số con</th><td>1</td><td>3</td><td>8</td><td>6</td><td>2</td></tr></table> Nhóm chứa tứ phân vị thứ nhất (Q1) là?",
            options: ["A. [17;18)", "B. [16;17)", "C. [14;15)", "D. [15;16)"],
            correct: 1 
        }
    ];

    const part2Data = [
        {
            id: "p2_q1",
            text: "Cho hàm số \\(y = x + \\frac{4}{x}\\).",
            sub_questions: [
                // Sửa lỗi đạo hàm y'
                { text: "a) Đạo hàm \\(y' = 1 + \\frac{4}{x^2}\\)", correct: false }, 
                { text: "b) Đồ thị hàm số có đường tiệm cận xiên \\(y = x+1\\)", correct: false }, 
                { text: "c) Đồ thị hàm số cắt trục hoành tại 2 điểm phân biệt.", correct: false }, 
                { text: "d) Đồ thị hàm số có dạng như hình vẽ (2 nhánh, cực trị tại -2 và 2)", correct: true }
            ]
        },
        {
            id: "p2_q2",
            text: "Trong không gian Oxyz, cho \\(\\Delta ABC\\) với \\(A(1;0;-2), B(-2;3;4), C(4;-6;1)\\).",
            sub_questions: [
                { text: "a) Tọa độ trung điểm M của đoạn thẳng BC là \\((1; -\\frac{3}{2}; \\frac{5}{2})\\)", correct: true }, 
                { text: "b) \\(\\overrightarrow{AB} = 3\\vec{i} - 3\\vec{j} + 6\\vec{k}\\)", correct: false }, 
                { text: "c) Số đo góc \\(\\widehat{A}\\) của tam giác ABC là \\(60^o\\)", correct: false }, 
                { text: "d) Nếu ABDC là hình bình hành thì tọa độ điểm D là \\((1;-3;7)\\)", correct: false }
            ]
        },
        {
            id: "p2_q3",
            text: "Cho mẫu số liệu ghép nhóm tần số thống kê về mức lương của hai công ty A, B như sau: <br> <table class='stats-table'><tr><th>Mức lương</th><td>[10;15)</td><td>[15;20)</td><td>[20;25)</td><td>[25;30)</td><td>[30;35)</td><td>[35;40)</td></tr><tr><th>Cty A</th><td>20</td><td>15</td><td>10</td><td>5</td><td>5</td><td>5</td></tr><tr><th>Cty B</th><td>15</td><td>18</td><td>10</td><td>10</td><td>5</td><td>2</td></tr></table>",
            sub_questions: [
                { text: "a) Giá trị đại diện của từng nhóm lần lượt là: 12,5; 17,5; 22,5; 27,5; 32,5; 37,5.", correct: true },
                { text: "b) Khoảng tứ phân vị của mẫu số liệu ghép nhóm thống kê mức lương công ty B là 30", correct: false },
                { text: "c) Số trung bình của mẫu số liệu Cty A là 26 (làm tròn đến hàng phần chục)", correct: false },
                { text: "d) Theo độ lệch chuẩn thì công ty A có mức lương đồng đều hơn công ty B", correct: false }
            ]
        }
    ];

    const part3Data = [
        {
            id: "p3_q1",
            text: "Một phòng học có thiết kế dạng hình hộp chữ nhật với chiều dài là 8m, chiều rộng là 6m và chiều cao là 5m... Tính khoảng cách từ điểm treo chiếc quạt (tâm trần) đến góc phòng học (O). <em>(kết quả làm tròn đến hàng phần trăm)</em>.",
            desc: "Hình vẽ mô phỏng: Hệ trục tọa độ Oxyz gắn vào góc phòng.",
            answer: "7.07", 
            tolerance: 0.1
        },
        {
            id: "p3_q2",
            text: "Theo thống kê điểm trung bình môn Toán của một số học sinh đã trúng tuyển vào lớp 10 năm học 2024 – 2025 được kết quả như bảng sau:<br> <table class='stats-table'> <tr> <th>Khoảng điểm</th> <td>[6.5; 7)</td> <td>[7; 7.5)</td> <td>[7.5; 8)</td> <td>[8; 8.5)</td> <td>[8.5; 9)</td> <td>[9; 9.5)</td> <td>[9.5; 10)</td> </tr> <tr> <th>Tần số</th> <td>7</td> <td>10</td> <td>17</td> <td>24</td> <td>13</td> <td>8</td> <td>5</td> </tr> </table> Khoảng tứ phân vị của mẫu số liệu ghép nhóm trên là <em>(Kết quả làm tròn đến hàng phần chục)</em>.",
            answer: "1.2", 
            tolerance: 0.2
        },
        {
            id: "p3_q3",
            text: "Trong 5 giây đầu tiên, một chất điểm chuyển động theo phương trình \\( s(t) = -t^3 + 6t^2 + t + 5 \\) (t: giây, s: mét). Chất điểm có vận tốc lớn nhất bằng bao nhiêu trong 5 giây đầu tiên đó?",
            desc: "Gợi ý: Tính v(t) = s'(t).",
            answer: "13", 
            tolerance: 0
        }
    ];

    // ================= XỬ LÝ LOGIC =================

    // Hàm đảo mảng (Fisher-Yates)
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Render câu hỏi
    function renderQuiz() {
        const container = document.getElementById('render-area');
        let html = '';

        // --- PHẦN 1 ---
        html += '<div class="part-title">PHẦN I. TRẮC NGHIỆM NHIỀU LỰA CHỌN (Chọn 1 đáp án đúng)</div>';
        const p1Shuffled = shuffle([...part1Data]);
        p1Shuffled.forEach((q, index) => {
            html += `<div class="question-box" id="box_${q.id}">
                <span class="q-text">Câu ${index + 1}: ${q.text}</span>
                <div class="options">
                    ${q.options.map((opt, i) => `
                        <label>
                            <input type="radio" name="${q.id}" value="${i}"> ${opt}
                        </label>
                    `).join('')}
                </div>
                <div class="explanation" id="exp_${q.id}"></div>
            </div>`;
        });

        // --- PHẦN 2 ---
        html += '<div class="part-title">PHẦN II. TRẮC NGHIỆM ĐÚNG SAI (Chọn Đ hoặc S cho mỗi ý)</div>';
        const p2Shuffled = shuffle([...part2Data]);
        p2Shuffled.forEach((q, index) => {
            html += `<div class="question-box" id="box_${q.id}">
                <span class="q-text">Câu ${index + 1}: ${q.text}</span>
                ${q.sub_questions.map((sub, i) => `
                    <div class="tf-row">
                        <div class="tf-content">${sub.text}</div>
                        <div class="tf-choices">
                            <label><input type="radio" name="${q.id}_${i}" value="true"> Đ</label>
                            <label><input type="radio" name="${q.id}_${i}" value="false"> S</label>
                        </div>
                    </div>
                    <div class="explanation" id="exp_${q.id}_${i}"></div>
                `).join('')}
            </div>`;
        });

        // --- PHẦN 3 ---
        html += '<div class="part-title">PHẦN III. TRẢ LỜI NGẮN (Điền số hoặc kết quả)</div>';
        const p3Shuffled = shuffle([...part3Data]);
        p3Shuffled.forEach((q, index) => {
            html += `<div class="question-box" id="box_${q.id}">
                <span class="q-text">Câu ${index + 1}: ${q.text}</span>
                ${q.desc ? `<div class="img-desc">${q.desc}</div>` : ''}
                <input type="text" class="short-ans" name="${q.id}" placeholder="Nhập đáp án...">
                <div class="explanation" id="exp_${q.id}"></div>
            </div>`;
        });

        container.innerHTML = html;
        // Kích hoạt MathJax render lại công thức
        MathJax.typesetPromise();
    }

    // Timer Logic
    let timeSeconds = 60 * 60;
    const timerElem = document.getElementById('timer');
    const timerInterval = setInterval(() => {
        timeSeconds--;
        const m = Math.floor(timeSeconds / 60);
        const s = timeSeconds % 60;
        timerElem.textContent = `${m}:${s < 10 ? '0'+s : s}`;
        
        if (timeSeconds <= 0) {
            clearInterval(timerInterval);
            alert("Hết giờ làm bài!");
            submitQuiz();
        }
    }, 1000);

    // Chấm điểm
    function submitQuiz() {
        clearInterval(timerInterval);
        
        // Disable nút nộp
        document.querySelector('.btn-submit').disabled = true;
        document.querySelector('.btn-submit').innerText = "ĐÃ NỘP BÀI";

        let totalScore = 0;
        let maxScore = 0; // Để tính scale

        // --- Chấm Phần 1 ---
        part1Data.forEach(q => {
            maxScore += 1;
            const selected = document.querySelector(`input[name="${q.id}"]:checked`);
            const expDiv = document.getElementById(`exp_${q.id}`);
            const box = document.getElementById(`box_${q.id}`);
            
            if (selected) {
                if (parseInt(selected.value) === q.correct) {
                    totalScore += 1;
                    box.classList.add('correct-ans');
                    expDiv.innerHTML = `<span style="color:green">✓ Chính xác!</span>`;
                } else {
                    box.classList.add('wrong-ans');
                    expDiv.innerHTML = `Đáp án đúng: ${q.options[q.correct]}`;
                }
            } else {
                box.classList.add('wrong-ans');
                expDiv.innerHTML = `Chưa chọn đáp án. Đáp án đúng: ${q.options[q.correct]}`;
            }
        });

        // --- Chấm Phần 2 ---
        part2Data.forEach(q => {
            q.sub_questions.forEach((sub, i) => {
                maxScore += 0.25; 
                const selected = document.querySelector(`input[name="${q.id}_${i}"]:checked`);
                const expDiv = document.getElementById(`exp_${q.id}_${i}`);
                
                const userVal = selected ? (selected.value === 'true') : null;
                
                if (userVal === sub.correct) {
                    totalScore += 0.25;
                    expDiv.innerHTML = `<span style="color:green">✓ Đúng</span>`;
                } else {
                    expDiv.innerHTML = `<span style="color:red">Sai. Đáp án: ${sub.correct ? 'Đúng' : 'Sai'}</span>`;
                }
            });
        });

        // --- Chấm Phần 3 ---
        part3Data.forEach(q => {
            maxScore += 1;
            const input = document.querySelector(`input[name="${q.id}"]`);
            const val = parseFloat(input.value.replace(',', '.')); // Xử lý dấu phẩy
            const expDiv = document.getElementById(`exp_${q.id}`);
            const box = document.getElementById(`box_${q.id}`);

            if (!isNaN(val) && Math.abs(val - parseFloat(q.answer)) <= q.tolerance) {
                totalScore += 1;
                box.classList.add('correct-ans');
                expDiv.innerHTML = `<span style="color:green">✓ Chính xác! (${q.answer})</span>`;
            } else {
                box.classList.add('wrong-ans');
                expDiv.innerHTML = `Đáp án đúng: ${q.answer}`;
            }
        });

        // Hiển thị kết quả
        const finalScore = ((totalScore / maxScore) * 10).toFixed(1); 
        document.getElementById('scoreDisplay').innerText = `Điểm: ${finalScore} / 10`;
        document.getElementById('resultModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
        window.scrollTo(0, 0);
    }

    window.onload = renderQuiz;

</script>
</body>
</html>
